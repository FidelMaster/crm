
<% content_for :title, "Detalle del Ticket ##{@ticket.id}" %>

<div class="w-full max-w-7xl mx-auto">
  <!-- Encabezado Principal -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-800"><%= @ticket.title %></h1>
      <p class="text-sm text-gray-500 mt-1">Ticket #<%= @ticket.id %> creado por <%= @ticket.created_by.name %></p>
    </div>
    <div class="mt-4 md:mt-0">
       <% if current_user&.admin? %>
        <% unless @ticket.billable? %>
         <%= link_to "Generar Facturación", edit_billing_ticket_path(@ticket), class: "rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" %>
       <% end %>
      <%= link_to "Exportar PDF", download_pdf_ticket_path(@ticket, format: :pdf), class: "rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" %>
     <% end %>
    </div>
  </div>

  <!-- Contenido del Ticket en Dos Columnas -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <!-- Columna Izquierda (Principal) -->
    <div class="lg:col-span-2 space-y-8">
      
      <!-- Tarjeta de Descripción -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 border-b pb-3 mb-4">Descripción del Problema</h3>
        <div class="prose max-w-none text-gray-600">
          <%= @ticket.description %>
        </div>
      </div>

      <!-- Tarjeta de Información de Contacto y Ubicación -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 border-b pb-3 mb-4">Detalles de Contacto y Ubicación</h3>
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
          <div>
            <dt class="text-sm font-medium text-gray-500">Nombre de Contacto</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @ticket.contact_name %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Teléfono de Contacto</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @ticket.contact_phone %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Grupo de Ubicación</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @ticket.location_group.description %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Ubicación</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @ticket.location.description %></dd>
          </div>
        </dl>
      </div>

 

      <!-- Sección de Comentarios -->
      <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Historial y Comentarios</h3>
  
          <div id="ticket_comments_list" class="divide-y divide-gray-200">
             <% if @ticket_comments.any? %>
                  <%= render @ticket_comments %>
            <% else %>
              <p class="text-gray-500 text-sm py-4">No hay comentarios todavía.</p>
           <% end %>
          </div>

          <div class="mt-6 border-t pt-6">
           <%= render "ticket_comments/form", ticket: @ticket, ticket_comment: @ticket_comment %>
          </div>
        </div>
      

    </div>

    <!-- Columna Derecha (Metadatos) -->
    <div class="lg:col-span-1 space-y-8">
      <% if @ticket.billable? %>
    <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-lg font-semibold text-gray-900 border-b pb-3 mb-4">Estado de Facturación</h3>
      <dl class="space-y-4">
        <div>
          <dt class="text-sm font-medium text-gray-500">Estado Actual</dt>
          <dd class="mt-1 text-sm font-semibold text-white bg-blue-500 rounded-full px-3 py-1 inline-block">
            <%= @ticket.billing_status.humanize %>
          </dd>
        </div>
        <% if @ticket.invoice_generate_date? %>
          <div>
            <dt class="text-sm font-medium text-gray-500">Fecha de Facturación</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= l(@ticket.invoice_generate_date, format: :long) %></dd>
          </div>
        <% end %>
         <% if @ticket.invoice_contact_ruc? %>
          <div>
            <dt class="text-sm font-medium text-gray-500">RUC</dt>
            <dd class="mt-1 text-sm text-gray-900"><%=  @ticket.invoice_contact_ruc %></dd>
          </div>
        <% end %>
         <div>
            <dt class="text-sm font-medium text-gray-500">Cliente en Factura</dt>
            <dd class="mt-1 text-sm text-gray-900"><%=  @ticket.invoice_contact_name %></dd>
          </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Costo del Servicio</dt>
          <dd class="mt-1 text-lg font-bold text-green-600"><%= number_to_currency(@ticket.cost) %></dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Detalles de Factura</dt>
          <dd class="mt-1 text-sm text-gray-700"><%= @ticket.invoice_details %></dd>
        </div>
        
        <!-- Acciones para cambiar el estado de facturación -->
        <div class="border-t pt-4">
          <h4 class="text-sm font-medium text-gray-600 mb-2">Acciones</h4>
          <div class="flex flex-col space-y-2"> 
            <% if @ticket.pending_approval? %>
              <div class="flex items-center space-x-2">
                <%= button_to "Aprobar", approve_billing_ticket_path(@ticket), method: :patch, class: "rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"  %>
                <%= button_to "Rechazar", reject_billing_ticket_path(@ticket), method: :patch, class: "w-full rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500" %>
              </div>
            
            <% elsif @ticket.payment_pending? && current_user&.admin? %>
              <%= button_to "Marcar como Pagado", mark_as_paid_ticket_path(@ticket), method: :patch, class:  "rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"  %>
            <% end %>
          </div>
        </div>
      </dl>
    </div>
  <% end %> 

      <div class="bg-white rounded-xl shadow-lg p-6">
        <dl class="space-y-4">
          <div>
            <dt class="text-sm font-medium text-gray-500">Estado</dt>
            <dd class="mt-1 text-sm font-semibold text-white bg-blue-500 rounded-full px-3 py-1 inline-block"><%= @ticket.status.description %></dd>
          </div>
           <% if current_user&.admin? %>
          <div class="border-t pt-4">
            <h4 class="text-sm font-medium text-gray-600 mb-2">Cambiar Estado</h4>
            <%= form_with(model: @ticket, url: update_status_ticket_path(@ticket), method: :patch) do |form| %>
              <div>
                <%= form.label :status_id, "Nuevo Estado", class: "sr-only" %>
                <%= form.collection_select :status_id, @ticket_statuses, :id, :description, 
                      { selected: @ticket.status_id }, 
                      { class: "block w-full rounded-md border-gray-300 shadow-sm" } %>
              </div>
              <div class="mt-3">
                <%= form.submit "Actualizar Estado", 
                      class: "w-full rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 cursor-pointer", 
                      data: { turbo_confirm: "¿Estás seguro de que quieres cambiar el estado de este ticket?" } %>
              </div>
            <% end %>
          </div>
              <% end %>
          <div>
            <dt class="text-sm font-medium text-gray-500">Prioridad</dt>
            <dd class="mt-1 text-sm font-semibold text-gray-900"><%= @ticket.priority %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Equipo Asignado</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @ticket.team.description %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Agente Asignado</dt>
            <dd class="mt-1 text-sm text-gray-900">
              <%= @ticket.assigned_to.present? ? @ticket.assigned_to.name : content_tag(:span, "No asignado", class: "text-gray-400 italic") %>
            </dd>

            <% if current_user&.admin? %>
              <div class="mt-2" data-controller="modal">
              
                
                <%# 👇 ESTRUCTURA DEL MODAL (oculto por defecto) 👇 %>
                   <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Asignar Agente y Visita</h3>
                    
                    <%= form_with(model: @ticket, url: assign_agent_ticket_path(@ticket), method: :patch) do |form| %>
                      <div class="space-y-4">
                        <div>
                          <%= form.label :assigned_to_id, "Seleccionar Agente", class: "block text-sm font-medium text-gray-700" %>
                          <%= form.collection_select :assigned_to_id, @agents, :id, :name, { prompt: "Seleccione un agente" }, { class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" } %>
                        </div>
                        <div>
                          <%= form.label :scheduled_date, "Fecha y Hora de Visita", class: "block text-sm font-medium text-gray-700" %>
                          <%= form.datetime_local_field :scheduled_date, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" %>
                        </div>
                      </div>
                      <div class="mt-6 flex justify-end space-x-3">
                       
                        <%= form.submit "Guardar Asignación", class: "rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 cursor-pointer" %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Tipo de Servicio</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @ticket.service_type.description %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Fecha Programada</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @ticket.scheduled_date ? l(@ticket.scheduled_date, format: :long) : "No definida" %></dd>
          </div>
           
        </dl>
      </div>

       <% if current_user&.admin? %>
           <!--  Tarjeta de Productos y Materiales -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Productos y Materiales Utilizados</h3>
        <!-- Formulario para añadir nuevos productos -->
        <div class="mt-6 border-t pt-6">
          <h4 class="text-md font-medium text-gray-800 mb-4">Añadir un nuevo producto</h4>
        <%= render "ticket_products/form", ticket: @ticket, ticket_product: @ticket_product, products: @products %>
        </div>

        <!-- Lista de productos añadidos -->
        <div id="ticket_products_list" class="divide-y divide-gray-200">
            <% if @ticket_products.any? %>
               <%= render @ticket_products %>
              <% end %>
        </div>
      </div>
          <% end %>

    </div>

  </div>
</div>